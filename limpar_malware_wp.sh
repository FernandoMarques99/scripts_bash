#!/bin/bash
# Preparando os caminhos dos diretorios para referenciar
mkdir /root/restaurar
pwd > /root/restaurar/diretorio
tr '/' ' ' < /root/restaurar/diretorio > /root/restaurar/caminho
awk '{print$1}' /root/restaurar/caminho > /root/restaurar/inicio
awk '{print$2}' /root/restaurar/caminho > /root/restaurar/user  
echo $(cat /root/restaurar/inicio) | sed "s/$(cat /root/restaurar/inicio)//g" /root/restaurar/diretorio > /root/restaurar/temporario1
echo $(cat /root/restaurar/user) | sed "s/$(cat /root/restaurar/user)//g" /root/restaurar/temporario1 > /root/restaurar/temporario2
awk '{print substr($0,4)}' < /root/restaurar/temporario2 > /root/restaurar/local
rm -f /root/restaurar/diretorio /root/restaurar/caminho /root/restaurar/temporario1 /root/restaurar/temporario2

# Referenciando os caminhos dos diretorios
inicio=$(cat /root/restaurar/inicio)
user=$(cat /root/restaurar/user)
caminho=$(cat /root/restaurar/local)
versao=$(wp --allow-root core version)

# Restaurando o Core do WordPress
mkdir /root/restaurar/wordpress
cd /root/restaurar/wordpress
wp core --allow-root download --version=$versao
cd /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/wp-admin /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/wp-includes /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/wp-*.php /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/index.php /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/readme.html /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/license.txt /$inicio/$user/$caminho
cp -rf /root/restaurar/wordpress/xmlrpc.php /$inicio/$user/$caminho

# Deletando plugin indejesados do WordPress
wp --allow-root plugin delete akismet --skip-plugins
wp --allow-root plugin delete hello --skip-plugins
wp --allow-root plugin delete wp-file-manager --skip-plugins
wp --allow-root plugin delete updraftplus --skip-plugins

# Atualizando Versões dos Plugins
echo $(wp --allow-root plugin list --field=name) | awk '{ gsub(/ /,"\n"); print }' > /root/restaurar/plugin_nome
echo $(wp --allow-root plugin list --field=version) | awk '{ gsub(/ /,"\n"); print }' > /root/restaurar/plugin_versao
sed -i "s/^/wp --allow-root plugin update /g" /root/restaurar/plugin_nome
sed -i "s/^/--version=/g" /root/restaurar/plugin_versao
sed -i "s/$/ --skip-plugins/" /root/restaurar/plugin_versao
paste /root/restaurar/plugin_nome /root/restaurar/plugin_versao > plugin_atualiza.sh
sed -i '1i #!/bin/bash' plugin_atualiza.sh
bash plugin_atualiza.sh
rm -f plugin_atualiza.sh

# Atualizando Versões dos Temas
echo $(wp --allow-root theme list --field=name) | awk '{ gsub(/ /,"\n"); print }' > /root/restaurar/theme_nome
echo $(wp --allow-root theme list --field=version) | awk '{ gsub(/ /,"\n"); print }' > /root/restaurar/theme_versao
sed -i "s/^/wp --allow-root theme update /g" /root/restaurar/theme_nome
sed -i "s/^/--version=/g" /root/restaurar/theme_versao
sed -i "s/$/ --skip-themes/" /root/restaurar/theme_versao
paste /root/restaurar/theme_nome /root/restaurar/theme_versao > theme_atualiza.sh
sed -i '1i #!/bin/bash' theme_atualiza.sh
bash theme_atualiza.sh
rm -f theme_atualiza.sh

# Limpar arquivos que não eram para estar no CORE
wp --allow-root core verify-checksums > /root/restaurar/arquivos_infectados 2>&1
cat /root/restaurar/arquivos_infectados | grep 'File should not exist:' | awk '{print $6}' > limpar_arquivos_wp.sh
sed -i "s/^/rm -f /g" limpar_arquivos_wp.sh
sed -i '1i #!/bin/bash' limpar_arquivos_wp.sh
bash limpar_arquivos_wp.sh
rm -f limpar_arquivos_wp

#Verificando o usuario do wordpress
usuario_wp=$(wp --allow-root user list --field=user_email| grep 'infra@serverdo.in')
if [ $usuario_wp = 'infra@serverdo.in' ]; then
    echo 'usuario criado, consulte a senha' > /root/usuario 2>&1
else
    wp --allow-root user create serverdoin infra@serverdo.in --role=administrator > /root/usuario 2>&1
fi

#Instalando o WordFence
wp --allow-root plugin install wordfence --activate
